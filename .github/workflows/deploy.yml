name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: false
        type: boolean

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'

jobs:
  # Run tests before deployment (unless skipped)
  test:
    name: Pre-deployment Tests
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    defaults:
      run:
        working-directory: backend

    env:
      APP_ENV: testing
      APP_DEBUG: true
      DB_CONNECTION: mysql
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: testing
      DB_USERNAME: root
      DB_PASSWORD: password
      CACHE_STORE: file
      SESSION_DRIVER: file
      QUEUE_CONNECTION: sync

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, pdo_mysql
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Create storage directories
        run: |
          mkdir -p storage/framework/cache/data
          mkdir -p storage/framework/sessions
          mkdir -p storage/framework/views
          mkdir -p bootstrap/cache
          chmod -R 775 storage bootstrap/cache

      - name: Copy environment file
        run: cp .env.example .env

      - name: Generate application key
        run: php artisan key:generate --force

      - name: Run database migrations
        run: php artisan migrate --force

      - name: Run PHPUnit tests
        run: vendor/bin/phpunit --configuration phpunit.xml.dist

  # Build frontend assets
  build:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build
        env:
          VITE_API_URL: https://uffizi.deetech.cc/api
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN_FRONTEND }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  # Deploy to production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: inputs.environment == 'production'
    environment:
      name: production
      url: https://uffizi.deetech.cc

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment timestamp
        id: timestamp
        run: echo "timestamp=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: Backup production database
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}/backend && \
            mysqldump -u \$DB_USERNAME -p\$DB_PASSWORD \$DB_DATABASE > backup_${{ steps.timestamp.outputs.timestamp }}.sql
          " || echo "Database backup skipped (may not have credentials)"

      - name: Deploy backend files
        run: |
          # Sync backend files (excluding sensitive directories)
          rsync -avz --delete \
            -e "ssh -p ${{ secrets.SSH_PORT }}" \
            --exclude='.env' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='bootstrap/cache/*' \
            --exclude='vendor' \
            --exclude='node_modules' \
            --exclude='backup_*.sql' \
            backend/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH }}/backend/

      - name: Deploy frontend files
        run: |
          # Deploy frontend build
          rsync -avz --delete \
            -e "ssh -p ${{ secrets.SSH_PORT }}" \
            frontend/dist/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: Run post-deployment tasks
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}/backend && \
            /opt/alt/php82/usr/bin/php -d memory_limit=512M /usr/local/bin/composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev && \
            /opt/alt/php82/usr/bin/php artisan migrate --force && \
            /opt/alt/php82/usr/bin/php artisan config:cache && \
            /opt/alt/php82/usr/bin/php artisan route:cache && \
            /opt/alt/php82/usr/bin/php artisan view:cache && \
            /opt/alt/php82/usr/bin/php artisan event:cache
          "

      - name: Health check
        run: |
          # Wait for deployment to settle
          sleep 10

          # Check if the API is responding
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://uffizi.deetech.cc/api/up || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Health check passed! API is responding with status $HTTP_STATUS"
          else
            echo "Health check warning: API returned status $HTTP_STATUS"
            # Don't fail deployment, just warn
          fi

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://uffizi.deetech.cc" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** ${{ steps.timestamp.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify the application is working correctly" >> $GITHUB_STEP_SUMMARY
          echo "2. Check Sentry for any new errors" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor logs: \`tail -f storage/logs/laravel.log\`" >> $GITHUB_STEP_SUMMARY

  # Staging deployment (placeholder - no staging server yet)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build]
    if: inputs.environment == 'staging'
    environment:
      name: staging

    steps:
      - name: Staging not configured
        run: |
          echo "Staging environment is not configured yet."
          echo "To add staging deployment:"
          echo "1. Set up a staging server"
          echo "2. Add staging-specific secrets"
          echo "3. Update this workflow with staging deployment steps"
          exit 1
